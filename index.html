<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Voting (Online)</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<!-- Tailwind (for design only) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

/* ========= Firebase Config ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.firebasestorage.app",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

/* ========= Globals ========= */
let db, auth, userId;
let visitorId = null;
let selectedVoteId = null;
let selectedVoteName = "";
let selectedVoteImage = "";
let votingEnabled = true;

/* ========= Performer Data ========= */
const performerData = {
  option1: { name: "Below", img: "https://i.imgur.com/DIyK2zX.jpeg" },
  option2: { name: "Deliverance", img: "https://i.imgur.com/s7Unz9r.jpeg" },
  option3: { name: "Mask Off", img: "https://i.imgur.com/x0BI8Mc.jpeg" },
  option4: { name: "Metro Motion", img: "https://i.imgur.com/4rG47gL.jpeg" },
  option5: { name: "Sin Game", img: "https://i.imgur.com/k75mMUz.jpeg" },
  option6: { name: "Anonymity", img: "https://i.imgur.com/3dJQFeX.jpeg" },
};

/* ========= DOM Ready ========= */
document.addEventListener("DOMContentLoaded", async () => {
  const app = initializeApp(firebaseConfig);
  initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),
    isTokenAutoRefreshEnabled: true
  });
  db = getFirestore(app);
  auth = getAuth(app);

  const locationButton = document.getElementById("begin-vote-btn");
  const performersContainer = document.getElementById("performers-container");
  const submitVoteButton = document.getElementById("submit-vote-btn");
  const confirmationMessage = document.getElementById("confirmation-message");
  const confirmationImage = document.getElementById("confirmation-image");

  // Load fingerprint
  FingerprintJS.load()
    .then(fp => fp.get())
    .then(r => { visitorId = r.visitorId; })
    .catch(() => console.warn("Fingerprint load failed."));

  // Firebase Auth
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      console.log("Anonymous user signed in:", user.uid);
      restoreVoteIfExists();
    } else {
      await signInAnonymously(auth);
    }
  });

  // Listen for voting enabled/disabled
  const settingsRef = doc(db, "lip_sync_2025_settings", "state");
  onSnapshot(settingsRef, (snap) => {
    if (snap.exists()) votingEnabled = snap.data().enabled;
  });

  // Voting buttons
  locationButton.addEventListener("click", () => {
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("voting-screen").classList.remove("hidden");
  });

  performersContainer.addEventListener("click", (e) => {
    const card = e.target.closest(".performer-card");
    if (!card || !votingEnabled) return;
    document.querySelectorAll(".performer-card").forEach(c => c.classList.remove("selected"));
    card.classList.add("selected");
    selectedVoteId = card.dataset.voteId;
    selectedVoteName = card.querySelector("h4").textContent;
    selectedVoteImage = card.querySelector("img").src;
    submitVoteButton.disabled = false;
    submitVoteButton.textContent = `Submit Vote for ${selectedVoteName}`;
    submitVoteButton.classList.add("ready");
  });

  submitVoteButton.addEventListener("click", () => submitVote(selectedVoteId, submitVoteButton, confirmationMessage, confirmationImage));
});

/* ========= Restore Vote ========= */
async function restoreVoteIfExists() {
  const snap = await getDoc(doc(db, "lip_sync_2025_votes", userId));
  if (snap.exists()) {
    const { voteId } = snap.data();
    const performer = performerData[voteId];
    if (performer) {
      document.getElementById("confirmation-image").src = performer.img;
      document.getElementById("confirmation-message").innerHTML = `
        You already voted for <b>${performer.name}</b>.<br><br>
        Thank you for participating in <b>Lip Sync: For Good!</b>
      `;
      setScreen("confirmation-screen");
    }
  }
}

/* ========= Helper ========= */
function setScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ========= Submit Vote with Fingerprint Protection ========= */
async function submitVote(voteId, btn, confirmationMessage, confirmationImage) {
  if (!visitorId) return alert("Fingerprint not ready.");
  if (!votingEnabled) return alert("Voting is currently disabled.");
  if (!userId) return alert("User not authenticated.");

  btn.disabled = true;
  btn.textContent = "Submitting...";

  try {
    // ðŸ”’ Duplicate check by fingerprint
    const fingerprintQuery = query(
      collection(db, "lip_sync_2025_votes"),
      where("fingerprint", "==", visitorId)
    );
    const fingerprintSnap = await getDocs(fingerprintQuery);

    if (!fingerprintSnap.empty) {
      confirmationImage.style.display = "none";
      confirmationMessage.innerHTML = `
        Youâ€™ve already voted on this device.<br><br>
        Thank you for participating in <b>Lip Sync: For Good!</b>
      `;
      setScreen("confirmation-screen");
      return;
    }

    // âœ… Submit new vote
    const voteRef = doc(db, "lip_sync_2025_votes", userId);
    await setDoc(voteRef, {
      voteId,
      createdAt: Date.now(),
      userId,
      fingerprint: visitorId,
      userAgent: navigator.userAgent,
      voteSource: "online"
    });

    confirmationImage.src = performerData[voteId].img;
    confirmationMessage.innerHTML = `
      Your vote for <b>${performerData[voteId].name}</b> has been recorded.<br><br>
      Thank you for attending <b>Lip Sync: For Good!</b>
    `;
    setScreen("confirmation-screen");

  } catch (e) {
    console.error(e);
    btn.disabled = false;
    btn.textContent = "Vote Failed â€“ Retry";
    alert("Error saving vote: " + e.message);
  }
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body { margin:0; height:100%; background:black; color:white; font-family:'Inter',sans-serif; overflow:hidden; }
#bg-video { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:0; opacity:0.8; }
.screen, .glass-card { position:relative; z-index:1; }
.glass-card { background:rgba(0,0,0,0.45); backdrop-filter:blur(24px); border-radius:1.5rem; border:1px solid rgba(255,255,255,0.15); }
.performer-card.selected { border:2px solid #22c55e; box-shadow:0 0 20px 3px rgba(34,197,94,0.5); }
#submit-vote-btn.ready { background-color:#22c55e !important; color:black !important; border:none !important; box-shadow:0 0 12px 2px rgba(34,197,94,0.6); transition:all 0.3s ease; }
.spinner { border:3px solid rgba(255,255,255,0.15); border-top-color:#fff; border-radius:50%; width:22px;height:22px; animation:spin .9s linear infinite; margin:0 auto; }
@keyframes spin{to{transform:rotate(360deg)}}
#performers-container { overflow-y:auto; padding-right:4px; -ms-overflow-style:none; scrollbar-width:none; }
#performers-container::-webkit-scrollbar { display:none; }
.screen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:1rem; }
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video">
  <source src="https://i.imgur.com/mAzP2S1.mp4" type="video/mp4">
</video>

<!-- LOGIN -->
<div id="login-screen" class="screen">
  <div class="glass-card flex flex-col items-center text-center p-8 w-11/12 max-w-md rounded-3xl">
    <img class="w-full max-w-[240px] mb-6" src="https://i.imgur.com/EnuWGLA.png" alt="Lip Sync Header">
    <p class="text-white/70 mb-6">Welcome to the online voting system! Click below to begin.</p>
    <button id="begin-vote-btn" class="px-8 py-3 text-base text-white rounded-xl border border-white/50 shadow-lg transition duration-200">Begin Voting</button>
  </div>
</div>

<!-- VOTING -->
<div id="voting-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-md rounded-3xl p-4 text-center flex flex-col max-h-[95vh] shadow-2xl">
    <img class="w-full max-w-[180px] mx-auto mb-4" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h3 class="text-xl font-semibold mb-2">Vote For Your Favorite Team!</h3>
    <p class="text-white/70 text-sm mb-4">Each device may submit only one vote.</p>

    <div id="performers-container" class="space-y-4 flex-1">
      ${Object.keys(performerData).map(id => `
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="${id}">
        <img src="${performerData[id].img}" class="w-full aspect-video object-cover rounded-lg mb-2" alt="${performerData[id].name}">
        <h4 class="text-lg font-semibold">${performerData[id].name}</h4>
      </div>`).join("")}
    </div>

    <button id="submit-vote-btn" class="mt-6 w-full py-3 px-8 text-base bg-black border border-white/50 text-white rounded-xl transition disabled:opacity-40" disabled>
      Select a Performer to Vote
    </button>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirmation-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-sm rounded-3xl p-8 text-center shadow-2xl">
    <h3 class="text-3xl font-bold mb-4 text-white">âœ… Submission Received!</h3>
    <img id="confirmation-image" class="w-full max-w-[240px] mx-auto rounded-xl mb-6" alt="Team Image">
    <p id="confirmation-message" class="text-white text-base mb-6"></p>
  </div>
</div>
</body>
</html>
