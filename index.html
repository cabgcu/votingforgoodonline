<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Voting</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.firebasestorage.app",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

/* Initialize Firebase + App Check */
const app = initializeApp(firebaseConfig);
initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),
  isTokenAutoRefreshEnabled: true
});

const db = getFirestore(app);
const auth = getAuth(app);

let userId = null;
let visitorId = null;
let selectedVoteId = null;
let selectedVoteName = "";
let selectedVoteImage = "";
let appInitialized = false;
let votingEnabled = true;

/* Performer Data */
const performerData = {
  option1: { name: "Below", img: "https://i.imgur.com/DIyK2zX.jpeg" },
  option2: { name: "Deliverance", img: "https://i.imgur.com/s7Unz9r.jpeg" },
  option3: { name: "Mask Off", img: "https://i.imgur.com/x0BI8Mc.jpeg" },
  option4: { name: "Metro Motion", img: "https://i.imgur.com/4rG47gL.jpeg" },
  option5: { name: "Sin Games", img: "https://i.imgur.com/k75mMUz.jpeg" },
  option6: { name: "Anonymity", img: "https://i.imgur.com/3dJQFeX.jpeg" },
};

/* DOM references */
let performersContainer, submitVoteButton, confirmationMessage, confirmationImage;

/* ================
   Phone Auth Setup
   ================ */
window.recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", { size: "invisible" });

async function sendCode() {
  const phoneNumber = document.getElementById("phoneInput").value.trim();
  if (!phoneNumber) return alert("Please enter your phone number.");
  try {
    const appVerifier = window.recaptchaVerifier;
    const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("verify-section").classList.remove("hidden");
    document.getElementById("sendCodeBtn").disabled = true;
    alert("Verification code sent!");
  } catch (e) {
    alert(e.message);
  }
}

async function verifyCode() {
  const code = document.getElementById("codeInput").value.trim();
  if (!code) return alert("Please enter the verification code.");
  try {
    const result = await window.confirmationResult.confirm(code);
    userId = result.user.uid;
    alert("Phone number verified!");
    setScreen("voting-screen");
    initApp();
  } catch {
    alert("Invalid or expired verification code.");
  }
}

/* ================
   Voting Functions
   ================ */
function setScreen(id) {
  document.querySelectorAll(".screen").forEach(el => el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

async function restoreVoteIfExists() {
  if (!visitorId) return;
  const snap = await getDoc(doc(db, "lip_sync_2025_votes", visitorId));
  if (snap.exists()) {
    const { voteId } = snap.data();
    if (performerData[voteId]) {
      const performer = performerData[voteId];
      confirmationImage.src = performer.img;
      confirmationMessage.innerHTML = `
        Your vote for <b>${performer.name}</b> has been recorded.<br><br>
        Thank you for attending <b>Lip Sync: For Good!</b>
      `;
      setScreen("confirmation-screen");
    }
  }
}

function handleCardSelection(e) {
  const card = e.target.closest(".performer-card");
  if (!card || !votingEnabled) return;
  document.querySelectorAll(".performer-card").forEach(c => c.classList.remove("selected"));
  card.classList.add("selected");
  selectedVoteId = card.dataset.voteId;
  selectedVoteName = card.querySelector("h4").textContent;
  selectedVoteImage = card.querySelector("img").src;

  submitVoteButton.disabled = false;
  submitVoteButton.textContent = `Submit Vote for ${selectedVoteName}`;
  submitVoteButton.classList.add("ready");
}

async function submitVote(voteId, btn) {
  if (!visitorId || !userId) return;
  if (!votingEnabled) return;
  btn.disabled = true;
  btn.textContent = "Submitting...";
  try {
    await setDoc(doc(db, "lip_sync_2025_votes", visitorId), {
      voteId,
      createdAt: Date.now(),
      userId,
      fingerprint: visitorId,
      userAgent: navigator.userAgent,
      source: "remote"
    });
    confirmationImage.src = selectedVoteImage;
    confirmationMessage.innerHTML = `
      Your vote for <b>${selectedVoteName}</b> has been recorded.<br><br>
      Thank you for attending <b>Lip Sync: For Good!</b>
    `;
    setScreen("confirmation-screen");
  } catch (e) {
    btn.disabled = false;
    btn.textContent = "Vote Failed – Retry";
    console.error(e);
  }
}

async function initApp() {
  performersContainer = document.getElementById("performers-container");
  submitVoteButton = document.getElementById("submit-vote-btn");
  confirmationMessage = document.getElementById("confirmation-message");
  confirmationImage = document.getElementById("confirmation-image");

  FingerprintJS.load()
    .then(fp => fp.get())
    .then(async r => {
      visitorId = r.visitorId;
      await restoreVoteIfExists();
    });

  performersContainer.addEventListener("click", handleCardSelection);
  submitVoteButton.addEventListener("click", () => submitVote(selectedVoteId, submitVoteButton));

  const settingsRef = doc(db, "lip_sync_2025_settings", "state");
  onSnapshot(settingsRef, (snap) => {
    if (snap.exists()) votingEnabled = snap.data().enabled;
  });
}

onAuthStateChanged(auth, (u) => {
  if (u) {
    userId = u.uid;
    if (!appInitialized) {
      appInitialized = true;
      initApp();
    }
  }
});
</script>

<!-- Styles -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
html, body {
  margin: 0; height: 100%;
  font-family: 'Inter', sans-serif;
  color: white; overflow: hidden;
  background-color: black;
}
#bg-video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 0; opacity: 0.8; }
.screen, .glass-card { position: relative; z-index: 1; }
.glass-card {
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(24px);
  border-radius: 1.5rem;
  border: 1px solid rgba(255,255,255,0.15);
}
.performer-card.selected {
  border: 2px solid #22c55e;
  box-shadow: 0 0 20px 3px rgba(34,197,94,0.5);
}
#submit-vote-btn.ready {
  background-color: #22c55e !important;
  color: black !important;
  border: none !important;
  box-shadow: 0 0 12px 2px rgba(34,197,94,0.6);
  transition: all 0.3s ease;
}
button.glow { animation: pink-green-glow 8s ease-in-out infinite; }
@keyframes pink-green-glow {
  0% { box-shadow: 0 0 15px 2px rgba(255,105,180,0.7); }
  50% { box-shadow: 0 0 25px 5px rgba(96,163,77,0.9); }
  100% { box-shadow: 0 0 15px 2px rgba(255,105,180,0.7); }
}
.screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 1rem; }
#recaptcha-container { display: none; }
.frosted-input {
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
  text-align: center;
}
.frosted-input::placeholder { color: rgba(255,255,255,0.6); text-align: center; }
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video">
  <source src="https://i.imgur.com/mAzP2S1.mp4" type="video/mp4">
</video>

<!-- PHONE VERIFY CARD -->
<div id="phone-auth-screen" class="screen">
  <div class="glass-card flex flex-col justify-between items-center text-center p-8 w-11/12 max-w-md rounded-3xl min-h-[460px] shadow-2xl mt-10 mb-10">
    <img class="w-full max-w-[240px] mb-6" src="https://i.imgur.com/EnuWGLA.png" alt="Lip Sync Vote Header">
    <p class="text-white/70 text-base mb-6 max-w-sm">Enter your phone number to verify and begin voting.</p>

    <div class="w-full flex flex-col items-center">
      <input id="phoneInput" type="tel" placeholder="+1 555 555 5555" class="frosted-input p-3 w-10/12 rounded-lg mb-3">
      <button id="sendCodeBtn" onclick="sendCode()" class="w-10/12 bg-white/20 py-2 rounded-lg mb-3">Send Code</button>

      <div id="verify-section" class="hidden w-10/12">
        <input id="codeInput" type="text" placeholder="Enter code" class="frosted-input p-3 w-full rounded-lg mb-3">
        <button onclick="verifyCode()" class="w-full bg-green-500 py-2 rounded-lg">Verify</button>
      </div>
    </div>

    <div id="recaptcha-container"></div>

    <footer class="pt-6 text-white/70 text-sm flex flex-col items-center max-w-sm mt-6">
      <img src="https://ik.imagekit.io/cabgcu/Untitled%20design-3.png" alt="CAB Logo" class="h-12 mb-3 object-contain">
      <p>Follow Us At <b>@CABGCU</b> On Instagram</p>
    </footer>
  </div>
</div>

<!-- VOTING SCREEN -->
<div id="voting-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-md rounded-3xl p-6 text-center shadow-2xl flex flex-col max-h-[90vh]">
    <img class="w-full max-w-[180px] mx-auto mb-4" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h3 class="text-xl font-semibold mb-2">Vote For Your Favorite Lip Sync Team!</h3>
    <p class="text-white/70 text-sm mb-4">Each attendee may submit only one vote per device.</p>

    <div id="performers-container" class="space-y-4 flex-1 overflow-y-auto">
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option1">
        <img src="https://i.imgur.com/DIyK2zX.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Below</h4>
      </div>
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option2">
        <img src="https://i.imgur.com/s7Unz9r.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Deliverance</h4>
      </div>
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option3">
        <img src="https://i.imgur.com/x0BI8Mc.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Mask Off</h4>
      </div>
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option4">
        <img src="https://i.imgur.com/4rG47gL.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Metro Motion</h4>
      </div>
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option5">
        <img src="https://i.imgur.com/k75mMUz.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Sin Games</h4>
      </div>
      <div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="option6">
        <img src="https://i.imgur.com/3dJQFeX.jpeg" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">Anonymity</h4>
      </div>
    </div>

    <button id="submit-vote-btn" class="mt-6 w-full py-3 px-8 text-base bg-black border border-white/50 text-white rounded-xl transition disabled:opacity-40" disabled>
      Select a Performer to Vote
    </button>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirmation-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-sm rounded-3xl p-8 text-center shadow-2xl">
    <h3 class="text-3xl font-bold mb-4 text-white">✅ Submission Received!</h3>
    <img id="confirmation-image" class="w-full max-w-[240px] mx-auto rounded-xl mb-6" alt="Team Image">
    <p id="confirmation-message" class="text-white text-base mb-6"></p>
  </div>
</div>
</body>
</html>
